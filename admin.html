<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Ajuste do input mês em telas pequenas */
    @media (max-width: 576px) {
      #selectMes, #selectMesMetodos {
        width: 100% !important;
      }
      .d-flex.justify-content-between {
        flex-direction: column;
        gap: 10px;
      }
      .nav-tabs .nav-link {
        font-size: 14px;
        padding: 8px;
      }
    }
    .table th, .table td {
      vertical-align: middle !important;
    }



/* Estilos para o dropdown em telas pequenas */
@media (max-width: 576px) {
  .dropdown-menu {
    position: absolute !important;
    right: 0;
    left: auto;
  }
  
  .dropdown-toggle::after {
    margin-left: 0.5em;
  }
  
  /* Ajuste para alinhar melhor o dropdown na tabela */
  td .dropdown {
    display: flex;
    justify-content: center;
  }
}
    


    

  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4 text-center">🔑 Painel Administrativo</h2>

    <!-- Abas -->
    <ul class="nav nav-tabs mb-3" id="adminTabs">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabContribuintes">Contribuintes</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabRelatorios">Relatórios</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMetodos">Pagamentos por Método</button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Aba Contribuintes -->
      <div class="tab-pane fade show active" id="tabContribuintes">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <button class="btn btn-success" id="btnNovoContribuinte">+ Adicionar Colaborador</button>
          <div class="d-flex align-items-center gap-2">
            <label for="selectMes" class="form-label mb-0"><strong>Mês/Ano:</strong></label>
            <input type="month" id="selectMes" class="form-control w-auto">
          </div>
        </div>
        <div class="table-responsive shadow">
          <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th>Nome</th>
                <th>Status</th>
                <th>Forma/Data Pagamento</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabelaContribuintes">
              <tr><td colspan="4" class="text-muted">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Aba Relatórios -->
      <div class="tab-pane fade" id="tabRelatorios">
        <div class="d-flex justify-content-between flex-wrap align-items-center mb-3 gap-2">
          <h5>Inadimplentes - <span id="mesAtualRelatorio"></span></h5>
          <button class="btn btn-danger" id="btnExportarPDF">📄 Exportar PDF</button>
        </div>

        <div class="card shadow p-3 mb-4">
          <h6 class="text-center">Percentual de Pagamentos</h6>
          <canvas id="graficoInadimplencia" height="120"></canvas>
        </div>

        <div class="table-responsive shadow">
          <table class="table table-striped table-bordered align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th>Nome</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tabelaInadimplentes">
              <tr><td colspan="2" class="text-muted">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Aba Pagamentos por Método -->
      <div class="tab-pane fade" id="tabMetodos">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <h5>Pagamentos por Método</h5>
          <div class="d-flex align-items-center gap-2">
            <label for="selectMesMetodos" class="form-label mb-0"><strong>Mês/Ano:</strong></label>
            <input type="month" id="selectMesMetodos" class="form-control w-auto">
          </div>
        </div>

        <!-- Pagamentos no mês -->
        <div class="card shadow p-3 mb-4">
          <h6 class="text-center">Pagamentos no mês selecionado</h6>
          <div class="table-responsive">
            <table class="table table-bordered text-center">
              <thead class="table-dark">
                <tr>
                  <th>Método</th>
                  <th>Quantidade</th>
                  <th>Valor (R$)</th>
                </tr>
              </thead>
              <tbody id="tabelaMetodosMes">
                <tr><td colspan="3" class="text-muted">Carregando...</td></tr>
              </tbody>
            </table>
          </div>
          <p class="text-end fw-bold">💰 Total do mês: <span id="totalMesValor">R$ 0,00</span></p>
        </div>

        <!-- Totais gerais -->
        <div class="card shadow p-3">
          <h6 class="text-center">Totais Gerais (Todos os meses)</h6>
          <div class="table-responsive">
            <table class="table table-bordered text-center">
              <thead class="table-dark">
                <tr>
                  <th>Método</th>
                  <th>Quantidade</th>
                  <th>Valor (R$)</th>
                </tr>
              </thead>
              <tbody id="tabelaMetodosTotal">
                <tr><td colspan="3" class="text-muted">Carregando...</td></tr>
              </tbody>
            </table>
          </div>
          <p class="text-end fw-bold">💰 Total geral: <span id="totalGeralValor">R$ 0,00</span></p>
        </div>
      </div>
    </div>
  </div>


  

  <!-- Modal Histórico de Pagamentos -->
  <div class="modal fade" id="modalHistorico" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Histórico de Pagamentos</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul id="listaHistorico" class="list-group"></ul>
          <div class="mt-3">
            <strong>Total contribuído: </strong> <span id="totalContribuido" class="text-success"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const mesAtual = new Date().toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
const mesAnoKey = new Date().toISOString().slice(0, 7);

let mesSelecionado = mesAnoKey; // padrão: mês atual
document.getElementById('selectMes').value = mesSelecionado;

// Atualiza label e carrega tabela ao trocar mês
document.getElementById('selectMes').addEventListener('change', (e) => {
  mesSelecionado = e.target.value;
  carregarTabela();
  carregarInadimplentes();
  atualizarGraficoInadimplencia();
});


    
    // ===============================
    // Carregar tabela de contribuintes
    // ===============================
    function carregarTabela() {
  db.ref('contribuintes').once('value', snap => {
    const lista = snap.val() || {};
    const tabela = document.getElementById('tabelaContribuintes');
    tabela.innerHTML = '';

    let totalPagoMes = 0;
    let promessas = [];

    Object.keys(lista).forEach(id => {
      const promessa = db.ref(`pagamentos/${mesSelecionado}/${id}`).once('value').then(pagSnap => {
        const pag = pagSnap.val() || { status: 'pendente' };
        const statusBadge = pag.status === 'pago'
          ? '<span class="badge bg-success">Pago</span>'
          : '<span class="badge bg-danger">Pendente</span>';

        const forma = pag.formaPagamento || pag.metodo || '-';
        const data = pag.dataPagamento 
          ? new Date(pag.dataPagamento).toLocaleDateString('pt-BR') 
          : '-';

        if (pag.status === 'pago') {
          totalPagoMes += pag.valorPago || 0;
        }

        tabela.innerHTML += `
        <tr>
          <td>
            <a href="#" onclick="verHistorico('${id}', '${lista[id].nome}')" class="text-primary">
              ${lista[id].nome}
            </a>
          </td>
          <td>${statusBadge}</td>
          <td>
            ${pag.status === 'pago' 
              ? `R$ ${(pag.valorPago || 0).toFixed(2)} <br>${forma} <br><small>${data}</small>` 
              : '-'}
          </td>
          <td>
  <div class="dropdown">
    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
      Ações
    </button>
    <ul class="dropdown-menu">
      <li><button class="dropdown-item" onclick="registrarPagamento('${id}')">Marcar Pago</button></li>
      <li><button class="dropdown-item" onclick="alterarStatus('${id}')">Alterar Status</button></li>
      <li><hr class="dropdown-divider"></li>
      <li><button class="dropdown-item text-danger" onclick="removerContribuinte('${id}')">Excluir</button></li>
    </ul>
  </div>
</td>
        </tr>`;
      });

      promessas.push(promessa);
    });

    // Quando todas as promessas terminarem, adiciona o total no final da tabela
    Promise.all(promessas).then(() => {
      tabela.innerHTML += `
        <tr class="table-secondary fw-bold">
          <td colspan="2" class="text-end">TOTAL PAGO NO MÊS:</td>
          <td colspan="2">R$ ${totalPagoMes.toFixed(2)}</td>
        </tr>`;
    });
  });
}
    carregarTabela();

    // ===============================
    // Registrar Pagamento
    // ===============================
    function registrarPagamento(id) {
      const hoje = new Date().toISOString().split('T')[0];
      Swal.fire({
        title: 'Registrar Pagamento',
        html: `
          <p>Valor sugerido: <strong>R$ 70,00</strong></p>
          <input type="number" id="valorPago" class="swal2-input" placeholder="Digite o valor pago" value="70">
          <label>Data do Pagamento:</label>
          <input type="date" id="dataPagamento" class="swal2-input" value="${hoje}">
          <label>Método:</label>
          <select id="metodoPagamento" class="swal2-input">
            <option value="Pix">Pix</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="Cartão">Cartão</option>
          </select>
        `,
        showCancelButton: true,
        confirmButtonText: 'Confirmar'
      }).then(result => {
        if (result.isConfirmed) {
          const valorPago = parseFloat(document.getElementById('valorPago').value) || 70;
          const dataPag = document.getElementById('dataPagamento').value;
          const metodo = document.getElementById('metodoPagamento').value;

          db.ref(`pagamentos/${mesSelecionado}/${id}`).set({
            status: 'pago',
            dataPagamento: dataPag,
            valorPago: valorPago,
            metodo: metodo
          });

          Swal.fire('✅ Sucesso', `Pagamento registrado: R$ ${valorPago.toFixed(2)} (${metodo})`, 'success');
          carregarTabela();
          atualizarGraficoInadimplencia();
          carregarInadimplentes();
        }
      });
    }

    // ===============================
    // Alterar Status Pago/Pendente
    // ===============================
    function alterarStatus(id) {
  db.ref(`pagamentos/${mesSelecionado}/${id}`).once('value', snap => {
    const dados = snap.val() || {};
    const atual = dados.status || 'pendente';
    const novoStatus = atual === 'pago' ? 'pendente' : 'pago';

    if (novoStatus === 'pago') {
      // Pergunta valor e forma de pagamento
      Swal.fire({
        title: 'Informe o valor pago e forma de pagamento',
        html: `
          <input type="number" id="valorPago" class="swal2-input" placeholder="Valor pago" value="70">
          <select id="formaPagamento" class="swal2-input">
            <option value="PIX">PIX</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="Cartão">Cartão</option>
          </select>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        preConfirm: () => {
          return {
            valor: parseFloat(document.getElementById('valorPago').value) || 70,
            forma: document.getElementById('formaPagamento').value
          };
        }
      }).then(result => {
        if (result.isConfirmed) {
          const { valor, forma } = result.value;
          const dataPagamento = new Date().toISOString();

          db.ref(`pagamentos/${mesSelecionado}/${id}`).update({
            status: 'pago',
            valorPago: valor,
            formaPagamento: forma,
            dataPagamento: dataPagamento
          }).then(() => {
            Swal.fire('✅ Sucesso', 'Status alterado para PAGO!', 'success');
            carregarTabela();
            atualizarGraficoInadimplencia();
            carregarInadimplentes();
          });
        }
      });

    } else {
      // Se mudar para pendente, zera o valor e a data
      Swal.fire({
        title: 'Confirmar alteração?',
        text: `Mudar status para PENDENTE?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim'
      }).then(result => {
        if (result.isConfirmed) {
          db.ref(`pagamentos/${mesSelecionado}/${id}`).update({
            status: 'pendente',
            valorPago: 0,
            formaPagamento: null,
            dataPagamento: null
          }).then(() => {
            Swal.fire('ℹ️ Atualizado', 'Status alterado para PENDENTE e valor zerado!', 'info');
            carregarTabela();
            atualizarGraficoInadimplencia();
            carregarInadimplentes();
          });
        }
      });
    }
  });
}

    // ===============================
    // Ver histórico individual
    // ===============================
    function verHistorico(id, nome) {
  document.querySelector('#modalHistorico .modal-title').innerText = `Histórico: ${nome}`;
  const lista = document.getElementById('listaHistorico');
  const totalElem = document.getElementById('totalContribuido');
  lista.innerHTML = '<li class="list-group-item text-muted">Carregando...</li>';
  totalElem.innerText = '';

  db.ref('pagamentos').once('value', snap => {
    const dados = snap.val() || {};
    let historico = [];
    let total = 0;

    Object.keys(dados).forEach(mes => {
      if (dados[mes][id] && dados[mes][id].status === 'pago') {
        const [ano, mesNum] = mes.split('-');
        historico.push({
          mes: new Date(Number(ano), Number(mesNum) - 1, 1)
            .toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }),
          valor: dados[mes][id].valorPago || 70,
          data: dados[mes][id].dataPagamento || '-',
          metodo: dados[mes][id].metodo || '-'
        });
        total += dados[mes][id].valorPago || 70;
      }
    });

    // 🔥 Adicionar o mês atual como pendente, caso não esteja no histórico
    const mesAtualKey = new Date().toISOString().slice(0, 7); // ex: "2025-08"
    const [anoAtual, mesAtualNum] = mesAtualKey.split('-');
    const mesAtualTexto = new Date(Number(anoAtual), Number(mesAtualNum) - 1, 1)
      .toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

    if (!historico.some(h => h.mes === mesAtualTexto)) {
      historico.unshift({
        mes: mesAtualTexto,
        valor: 0,
        data: '-',
        metodo: '-'
      });
    }

    lista.innerHTML = '';
    if (historico.length === 0) {
      lista.innerHTML = '<li class="list-group-item text-muted">Nenhum pagamento registrado</li>';
    } else {
      historico.reverse().forEach(item => {
        lista.innerHTML += `
          <li class="list-group-item">
            <strong>${item.mes}</strong><br>
            Valor: R$ ${item.valor.toFixed(2)} | Data: ${item.data} | Método: ${item.metodo}
          </li>`;
      });
    }
    totalElem.innerText = `R$ ${total.toFixed(2)}`;
  });

  new bootstrap.Modal(document.getElementById('modalHistorico')).show();
}




    // ===============================
    // Remover Contribuinte
    // ===============================
    function removerContribuinte(id) {
      Swal.fire({
        title: 'Tem certeza?',
        text: "Essa ação não pode ser desfeita!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, excluir'
      }).then((result) => {
        if (result.isConfirmed) {
          db.ref(`contribuintes/${id}`).remove();
          Swal.fire('Removido!', 'O contribuinte foi excluído.', 'success');
          carregarTabela();
        }
      });
    }

    // ===============================
    // Adicionar Contribuinte
    // ===============================
    // Adicionar novo colaborador
document.getElementById('btnNovoContribuinte').addEventListener('click', () => {
  Swal.fire({
    title: 'Adicionar Novo Colaborador',
    html: `
      <input type="text" id="nomeColaborador" class="swal2-input" placeholder="Nome completo">
      
    `,
    showCancelButton: true,
    confirmButtonText: 'Adicionar'
  }).then(result => {
    if (result.isConfirmed) {
      const nome = document.getElementById('nomeColaborador').value.trim();
      

      if (!nome) {
        Swal.fire('⚠️ Atenção', 'O nome é obrigatório!', 'warning');
        return;
      }

      const id = db.ref('contribuintes').push().key;
      db.ref(`contribuintes/${id}`).set({ nome });

      Swal.fire('✅ Sucesso', `${nome} foi adicionado como colaborador!`, 'success');
      carregarTabela();
    }
  });
});

    // ===============================
    // Relatórios: Inadimplentes
    // ===============================
    function carregarInadimplentes() {
      db.ref('contribuintes').once('value', snap => {
        const lista = snap.val() || {};
        const tabelaInad = document.getElementById('tabelaInadimplentes');
        tabelaInad.innerHTML = '';

        Object.keys(lista).forEach(id => {
          db.ref(`pagamentos/${mesSelecionado}/${id}`).once('value', pagSnap => {
            const pag = pagSnap.val() || { status: 'pendente' };
            if (pag.status !== 'pago') {
              tabelaInad.innerHTML += `
                <tr>
                  <td>${lista[id].nome}</td>
                  
                  <td><span class="badge bg-danger">Pendente</span></td>
                </tr>`;
            }
          });
        });
      });
    }

    // ===============================
    // Exportar PDF
    // ===============================
    const { jsPDF } = window.jspdf;
    document.getElementById('btnExportarPDF').addEventListener('click', () => {
      const pdf = new jsPDF();
      pdf.setFontSize(16);
      pdf.text(`Relatório de Inadimplentes - ${mesAtual}`, 10, 15);
      pdf.setFontSize(12);

      let linhaY = 30, totalArrecadado = 0;
      db.ref('pagamentos/' + mesAnoKey).once('value', pagSnap => {
        pagSnap.forEach(pag => {
          if (pag.val().status === 'pago') {
            totalArrecadado += pag.val().valorPago || 70;
          }
        });
      });

      db.ref('contribuintes').once('value', snap => {
        const lista = snap.val() || {};
        Object.keys(lista).forEach(id => {
          db.ref(`pagamentos/${mesSelecionado}/${id}`).once('value', pSnap => {
            const pag = pSnap.val() || { status: 'pendente' };
            if (pag.status !== 'pago') {
              pdf.text(`- ${lista[id].nome}`, 10, linhaY);
              linhaY += 8;
            }
          });
        });

        setTimeout(() => {
          pdf.text(`\n\n💰 Total arrecadado: R$ ${totalArrecadado.toFixed(2)}`, 10, linhaY + 10);
          pdf.save(`Inadimplentes_${mesAnoKey}.pdf`);
        }, 1000);
      });
    });

    // ===============================
    // Gráfico de Inadimplência
    // ===============================
    const ctxInad = document.getElementById('graficoInadimplencia').getContext('2d');
    const graficoInad = new Chart(ctxInad, {
      type: 'doughnut',
      data: {
        labels: ['Pagos', 'Pendentes'],
        datasets: [{
          data: [0, 0],
          backgroundColor: ['#28a745', '#dc3545'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed} contribuintes` } }
        }
      }
    });

    function atualizarGraficoInadimplencia() {
      db.ref('contribuintes').once('value', snap => {
        const lista = snap.val() || {};
        let pagos = 0, pendentes = 0;

        const promises = Object.keys(lista).map(id => 
          db.ref(`pagamentos/${mesSelecionado}/${id}`).once('value').then(pagSnap => {
            const pag = pagSnap.val() || { status: 'pendente' };
            if (pag.status === 'pago') pagos++;
            else pendentes++;
          })
        );

        Promise.all(promises).then(() => {
          graficoInad.data.datasets[0].data = [pagos, pendentes];
          graficoInad.update();
        });
      });
    }

    // Atualizar relatórios ao abrir aba
    document.querySelector('button[data-bs-target="#tabRelatorios"]').addEventListener('click', () => {
      carregarInadimplentes();
      atualizarGraficoInadimplencia();
    });



    

    

// ===============================
// Pagamentos por Método (Mês e Total)
// ===============================
document.getElementById('selectMesMetodos').value = mesSelecionado;
document.getElementById('selectMesMetodos').addEventListener('change', (e) => {
  mesSelecionado = e.target.value;
  carregarMetodosMes();
});
carregarMetodosMes();
carregarMetodosTotal();

function carregarMetodosMes() {
  db.ref(`pagamentos/${mesSelecionado}`).once('value', snap => {
    const dados = snap.val() || {};
    const tabela = document.getElementById('tabelaMetodosMes');
    tabela.innerHTML = '';
    let resumo = {}, totalMes = 0;

    Object.values(dados).forEach(p => {
      if (p.status === 'pago') {
        const metodo = p.metodo || p.formaPagamento || 'Não informado';
        const valor = parseFloat(p.valorPago) || 70;

        if (!resumo[metodo]) resumo[metodo] = { qtd: 0, valor: 0 };
        resumo[metodo].qtd++;
        resumo[metodo].valor += valor;
        totalMes += valor;
      }
    });

    Object.keys(resumo).forEach(m => {
      tabela.innerHTML += `
        <tr>
          <td>${m}</td>
          <td>${resumo[m].qtd}</td>
          <td>R$ ${resumo[m].valor.toFixed(2)}</td>
        </tr>`;
    });

    if (!Object.keys(resumo).length) {
      tabela.innerHTML = `<tr><td colspan="3" class="text-muted">Nenhum pagamento</td></tr>`;
    }

    document.getElementById('totalMesValor').innerText = `R$ ${totalMes.toFixed(2)}`;
  });
}

function carregarMetodosTotal() {
  db.ref(`pagamentos`).once('value', snap => {
    const dados = snap.val() || {};
    const tabela = document.getElementById('tabelaMetodosTotal');
    tabela.innerHTML = '';
    let resumo = {}, totalGeral = 0;

    Object.values(dados).forEach(mes => {
      Object.values(mes).forEach(p => {
        if (p.status === 'pago') {
          const metodo = p.metodo || p.formaPagamento || 'Não informado';
          const valor = parseFloat(p.valorPago) || 70;

          if (!resumo[metodo]) resumo[metodo] = { qtd: 0, valor: 0 };
          resumo[metodo].qtd++;
          resumo[metodo].valor += valor;
          totalGeral += valor;
        }
      });
    });

    Object.keys(resumo).forEach(m => {
      tabela.innerHTML += `
        <tr>
          <td>${m}</td>
          <td>${resumo[m].qtd}</td>
          <td>R$ ${resumo[m].valor.toFixed(2)}</td>
        </tr>`;
    });

    if (!Object.keys(resumo).length) {
      tabela.innerHTML = `<tr><td colspan="3" class="text-muted">Nenhum pagamento</td></tr>`;
    }

    document.getElementById('totalGeralValor').innerText = `R$ ${totalGeral.toFixed(2)}`;
  });
}

    

    





  </script>
</body>
</html>
